# selfsup_sota_fixed.yaml
# ğŸ”§ NaNé—®é¢˜å®Œå…¨ä¿®å¤ç‰ˆ - è§£å†³15ä¸ªepochåçš„æ•°å€¼ç¨³å®šæ€§é—®é¢˜

seed: 42

data:
  data_root: none
  labeled_csv: "./scripts/dataset/train_5p.csv"
  val_csv: "./scripts/dataset/val_5p.csv"
  unlabeled_csv: "./scripts/dataset/unlabeled_5p_nolabel.csv"
  num_classes: 12
  class_names:
    - "Good"
    - "Excessive Convexity"
    - "Undercut"
    - "Excessive Penetration"
    - "Incomplete Penetration"
    - "Lack of Fusion"
    - "Overlap"
    - "Porosity"
    - "Spatter"
    - "Arc Strike"
    - "Crack"
    - "Burn Through"

  sampler: "weighted"
  num_workers_train: 4
  num_workers_val: 2
  num_workers_unl: 4

video:
  num_frames: 8
  size: 224
  fps: 8

audio:
  sample_rate: 16000
  n_fft: 1024
  hop_length: 256
  n_mels: 80
  fmin: 20
  fmax: 7600

model:
  video_backbone:
    name: "resnet18"
    weights: "imagenet"
    frozen_stages: 0
    out_dim: 512

  audio_backbone:
    name: "light_vggish"
    weights: "none"
    frozen_stages: 0
    out_dim: 128

  fusion:
    type: "coattn"
    d_model: 256
    layers: 2
    heads: 8

  init_bias: true
  mil:
    topk_ratio: 0.15     # è®­ç»ƒæœŸæ›´â€œæŒ‘å‰”â€ï¼Œé™ä½é•¿å°¾å™ªå£°å¹²æ‰°
    dropout: 0.3
    attn_temp: 0.9       # éªŒè¯æœŸæ³¨æ„åŠ›ç•¥å°–é”
  use_aux_heads: true

# ============================================================================
# CAVAé…ç½® - é™ä½æƒé‡æé«˜ç¨³å®šæ€§
# ============================================================================
cava:
  enabled: true
  delta_low_frames: 2.0
  delta_high_frames: 6.0
  gate_clip_min: 0.1
  gate_clip_max: 0.9

  # åˆ†å¸ƒ-ç±»åˆ«ç›‘ç£/è‡ªç›‘ç£æƒé‡ä¸æœ€å¤§åˆ†å¸ƒæ—¶å»¶
  lambda_causal_sup: 0.0
  lambda_causal_unsup: 0.0
  dist_max_delay: 6

  # ğŸ”§ é™ä½æŸå¤±æƒé‡ï¼Œé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸
  lambda_align: 0.05         # ä»0.05é™åˆ°0.03
  lambda_prior: 0.00         # ä¿æŒç¦ç”¨
  lambda_edge: 0.01          # ä»0.005é™åˆ°0.003
  inject: pre_fusion     # è®© CAVA åœ¨é€å…¥ coattn å‰å¯¹é½éŸ³é¢‘
  use_in_coattn: true    # æ ‡è®° coattn è·¯å¾„ä¹Ÿè¦å¯ç”¨ CAVA
  use_infonce: true
  tau: 0.07                  # ä»0.07æé«˜åˆ°0.1ï¼Œå‡å°‘expæ•°å€¼é—®é¢˜

  #prior_mu: 4.0
  #prior_sigma: 1.0
  gate_min: 0.15     # â† é…åˆä¸Šé¢çš„é—¨æ§é˜ˆå€¼
  edge_margin_ratio: 0.25

  # ğŸ”¥ æ–°å¢ï¼šæ¢¯åº¦è£å‰ª
  clip_cava_grad: true    # åœ¨CAVAå†…éƒ¨è£å‰ªæ¢¯åº¦
  max_cava_grad: 10.0     # CAVAæ¢¯åº¦ä¸Šé™

# ============================================================================
# MLPRé…ç½® - å¤§å¹…é™ä½æ›´æ–°é¢‘ç‡
# ============================================================================
mlpr:
  enabled: true

  use_history_stats: true
  use_cava_signal: true
  use_prob_vector: false

  weight_clip: [0.05, 0.95]

  # ğŸ”§ æ›´é«˜çš„EMAè¡°å‡
  ema_decay: 0.9998           # ä»0.9998æé«˜åˆ°0.9999

  history_momentum: 0.9

  # ğŸ”§ å¤§å¹…é™ä½å…ƒå­¦ä¹ å‚æ•°
  meta_lr: 1.0e-4             # ä»2e-5é™åˆ°1e-5
  T: 0.7
  lambda_u: 0.2
  ramp_up_epochs: 10

  # ğŸ”§ å¤§å¹…é™ä½å…ƒå­¦ä¹ æ›´æ–°é¢‘ç‡
  meta_interval: 50          # ä»50å¢åŠ åˆ°100
  inner_lr: 1.0e-5            # ä»2e-5é™åˆ°1e-5

# ============================================================================
# æŸå¤±å‡½æ•°é…ç½® - é™ä½Focalç³»æ•°
# ============================================================================
loss:
  name: "ce"                  #focal_ce
  gamma: 1.0                  # ä»1.5é™åˆ°1.0ï¼Œå‡å°‘æç«¯æ¢¯åº¦
  label_smoothing: 0.0
  class_weights: null

# ============================================================================
# è®­ç»ƒé…ç½® - é™ä½å­¦ä¹ ç‡å’Œæ¢¯åº¦è£å‰ª
# ============================================================================
training:
  use_ssl: true
  amp:  false                   # å‰15ä¸ªepochä½¿ç”¨
  amp_disable_epoch: 15       # ğŸ”§ æ–°å¢ï¼š15ä¸ªepochåè‡ªåŠ¨ç¦ç”¨AMP

  batch_size: 16
  num_epochs: 30
  early_stop_patience: 6  # éªŒè¯é•¿æœŸä¸å‡è§¦å‘æ—©åœï¼ˆtraineré‡Œå·²æ”¯æŒï¼‰
  # ğŸ”§ é™ä½å­¦ä¹ ç‡
  learning_rate: 5e-5       # ä»5e-5é™åˆ°3e-5

  # ğŸ”§ æ›´ä¸¥æ ¼çš„æ¢¯åº¦è£å‰ª
  gradient_clip: 10         # ä»1.0é™åˆ°0.5
  grad_clip_norm: 0.5         # ä»1.0é™åˆ°0.5

  backbone_lr_mult: 0.1
  weight_decay: 1.0e-3

  # åŠç›‘ç£é…ç½®
  ssl:
    ema_decay_init: 0.99
    ema_decay: 0.999
    warmup_epochs: 5
    final_thresh: 0.9
    consistency_temp: 1.0
    lambda_u: 1.0
    use_dist_align: true       # åˆ†å¸ƒå¯¹é½ (ReMixMatch)  :contentReference[oaicite:3]{index=3}
    use_cls_threshold: true    # ç±»è‡ªé€‚åº”é˜ˆå€¼ (FlexMatch ç®€åŒ–)  :contentReference[oaicite:4]{index=4}
    thr_min: 0.05
    cls_thr_momentum: 0.9
    adaptive_thresh: true
    eval_with_ema:  "auto"   # "auto"/"student"/"teacher"      # éªŒè¯ç”¨ EMA æ•™å¸ˆ  :contentReference[oaicite:5]{index=5}

  # ğŸ”§ æ–°å¢ï¼šæ•°å€¼ç¨³å®šæ€§é…ç½®
  numerical_stability:
    check_nan: true           # å¯ç”¨NaNæ£€æŸ¥
    nan_recovery: true        # å¯ç”¨NaNæ¢å¤æœºåˆ¶
    gradient_anomaly_detection: true
    reinit_on_nan: true       # NaNæ—¶é‡æ–°åˆå§‹åŒ–æœ€åä¸€å±‚

# ============================================================================
# è¯„ä¼°é…ç½®
# ============================================================================
eval:
  tune_thresholds: false
  metrics_topk: 1
